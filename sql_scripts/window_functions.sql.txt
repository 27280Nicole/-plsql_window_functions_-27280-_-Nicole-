-- Ranking customers based on total revenue
SELECT
    c.customer_id,
    c.customer_name,
    SUM(s.total_amount) AS total_revenue,

    ROW_NUMBER() OVER (ORDER BY SUM(s.total_amount) DESC) AS row_num,
    RANK() OVER (ORDER BY SUM(s.total_amount) DESC) AS rank_num,
    DENSE_RANK() OVER (ORDER BY SUM(s.total_amount) DESC) AS dense_rank_num,
    PERCENT_RANK() OVER (ORDER BY SUM(s.total_amount) DESC) AS percent_rank_num

FROM sales s
JOIN customers c ON s.customer_id = c.customer_id
GROUP BY c.customer_id, c.customer_name;


-- Running monthly sales totals using window functions
SELECT
    sale_date,
    total_amount,

    SUM(total_amount) OVER (
        ORDER BY sale_date
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS running_total,

    AVG(total_amount) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg_3_sales

FROM sales;



-- Month-over-month sales comparison
SELECT
    sale_date,
    total_amount,

    LAG(total_amount) OVER (ORDER BY sale_date) AS previous_sale,
    LEAD(total_amount) OVER (ORDER BY sale_date) AS next_sale,

    total_amount - LAG(total_amount) OVER (ORDER BY sale_date) AS growth_difference

FROM sales;


-- Customer segmentation using distribution functions
SELECT
    c.customer_id,
    c.customer_name,
    SUM(s.total_amount) AS total_revenue,

    NTILE(4) OVER (ORDER BY SUM(s.total_amount) DESC) AS revenue_quartile,
    CUME_DIST() OVER (ORDER BY SUM(s.total_amount) DESC) AS cumulative_distribution

FROM sales s
JOIN customers c ON s.customer_id = c.customer_id
GROUP BY c.customer_id, c.customer_name;


